pipeline {
  agent any

  environment {
    AWS_REGION = 'ap-south-1'
    CLUSTER_NAME = 'cluster'
    GIT_REPO = 'https://github.com/krunalbhandekar/devopsified-mern-app.git'
    KUBECONFIG = '/var/lib/jenkins/.kube/config'
    DOCKERHUB_USERNAME = 'krunalbhandekar10'
    DOCKERHUB_CREDENTIALS_ID = 'dockerhub-cred-id'
    MONGO_CREDENTIALS_ID = 'mongo-cred-id'
    AWS_CREDENTIALS_ID = 'aws-cred-id'
  }

  stages {

    stage('Checkout Project') {
            steps {
                script {
                    try {
                        git branch: 'main', url: "${env.GIT_REPO}"
                        echo "‚úÖ Successfully checked out repository"
                    } catch (Exception e) {
                        error "‚ùå Failed to checkout repository: ${e.getMessage()}"
                    }
                }
            }
        }
        
        stage('Validate Prerequisites') {
            steps {
                script {
                    try {
                        sh '''
                            # Check if required tools are installed
                            command -v docker >/dev/null 2>&1 || { echo "Docker not found"; exit 1; }
                            command -v kubectl >/dev/null 2>&1 || { echo "kubectl not found"; exit 1; }
                            command -v aws >/dev/null 2>&1 || { echo "AWS CLI not found"; exit 1; }
                            
                            # Check if Dockerfiles exist
                            if [ ! -f "Dockerfile.client" ]; then
                                echo "‚ùå Dockerfile.client not found"
                                exit 1
                            fi
                            if [ ! -f "Dockerfile.server" ]; then
                                echo "‚ùå Dockerfile.server not found"
                                exit 1
                            fi
                            
                            echo "‚úÖ All prerequisites validated"
                        '''
                    } catch (Exception e) {
                        error "‚ùå Prerequisites validation failed: ${e.getMessage()}"
                    }
                }
            }
        }

 stage('Update kubeconfig') {
            steps {
                withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: "${AWS_CREDENTIALS_ID}", secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    script {
                        try {
                            sh '''
                                # Create .kube directory with proper permissions
                                echo "üìÅ Creating .kube directory..."
                                mkdir -p /var/lib/jenkins/.kube
                                chmod 700 /var/lib/jenkins/.kube
                                
                                # Verify AWS credentials
                                echo "üîç Verifying AWS credentials..."
                                aws sts get-caller-identity
                                
                                # Check if AWS CLI is configured properly
                                echo "üîß Checking AWS configuration..."
                                aws configure list
                                
                                # Verify EKS cluster exists
                                echo "üîç Checking if EKS cluster exists..."
                                aws eks describe-cluster --region ${AWS_REGION} --name ${CLUSTER_NAME}
                                
                                # Update kubeconfig with verbose output
                                echo "üîß Updating kubeconfig..."
                                aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME} --kubeconfig ${KUBECONFIG} --verbose
                                
                                # Set proper permissions
                                chmod 600 ${KUBECONFIG}
                                
                                # Verify kubeconfig was created
                                echo "üìÑ Checking kubeconfig file..."
                                ls -la ${KUBECONFIG}
                                
                                # Test kubectl connection
                                echo "üîç Testing kubectl connection..."
                                kubectl cluster-info --request-timeout=30s
                                
                                echo "‚úÖ kubeconfig updated successfully"
                            '''
                        } catch (Exception e) {
                            // Enhanced error handling with debugging info
                            sh '''
                                echo "‚ùå Debugging kubeconfig update failure..."
                                echo "Current user: $(whoami)"
                                echo "HOME directory: $HOME"
                                echo "AWS CLI version: $(aws --version)"
                                echo "kubectl version: $(kubectl version --client)"
                                echo "Current AWS region: $AWS_REGION"
                                echo "Cluster name: $CLUSTER_NAME"
                                echo "Kubeconfig path: $KUBECONFIG"
                                
                                # Check if .kube directory exists
                                if [ -d "/var/lib/jenkins/.kube" ]; then
                                    echo "‚úÖ .kube directory exists"
                                    ls -la /var/lib/jenkins/.kube/ || echo "Directory is empty"
                                else
                                    echo "‚ùå .kube directory does not exist"
                                fi
                                
                                # Check AWS credentials
                                echo "üîç AWS credential check:"
                                aws sts get-caller-identity || echo "‚ùå AWS credentials not configured"
                                
                                # List available clusters
                                echo "üîç Available EKS clusters:"
                                aws eks list-clusters --region ${AWS_REGION} || echo "‚ùå Cannot list clusters"
                                
                                # Check if cluster exists
                                echo "üîç Checking specific cluster:"
                                aws eks describe-cluster --region ${AWS_REGION} --name ${CLUSTER_NAME} || echo "‚ùå Cluster not found or no access"
                            '''
                            error "‚ùå Failed to update kubeconfig: ${e.getMessage()}"
                        }
                    }
                }
            }
        }

          stage('Docker Login') {
            steps {
                script {
                    try {
                        withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CREDENTIALS_ID}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                            sh '''
                                echo "üîê Logging into Docker Hub..."
                                echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                                echo "‚úÖ Docker login successful"
                            '''
                        }
                    } catch (Exception e) {
                        error "‚ùå Docker login failed: ${e.getMessage()}"
                    }
                }
            }
        }


 stage('Build & Push Docker Images') {
            parallel {
                stage('Build Client Image') {
                    steps {
                        script {
                            try {
                                sh '''
                                    echo "üèóÔ∏è Building client image..."
                                    export DOCKER_BUILDKIT=0
                                    
                                    # Build with build number tag
                                    docker build -t ${DOCKERHUB_USERNAME}/mern-client:${BUILD_NUMBER} -f Dockerfile.client .
                                    
                                    echo "üì§ Pushing client image..."
                                    docker push ${DOCKERHUB_USERNAME}/mern-client:${BUILD_NUMBER}
                                    
                                    echo "‚úÖ Client image built and pushed successfully"
                                '''
                            } catch (Exception e) {
                                error "‚ùå Failed to build/push client image: ${e.getMessage()}"
                            }
                        }
                    }
                }
                
                stage('Build Server Image') {
                    steps {
                        script {
                            try {
                                sh '''
                                    echo "üèóÔ∏è Building server image..."
                                    export DOCKER_BUILDKIT=0
                                    
                                    # Build with build number tag
                                    docker build -t ${DOCKERHUB_USERNAME}/mern-server:${BUILD_NUMBER} -f Dockerfile.server .
                                    
                                    echo "üì§ Pushing server image..."
                                    docker push ${DOCKERHUB_USERNAME}/mern-server:${BUILD_NUMBER}
                                    
                                    echo "‚úÖ Server image built and pushed successfully"
                                '''
                            } catch (Exception e) {
                                error "‚ùå Failed to build/push server image: ${e.getMessage()}"
                            }
                        }
                    }
                }
            }
        }
    
      stage('Verify EKS Access') {
            steps {
                withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: "${AWS_CREDENTIALS_ID}", secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    script {
                        try {
                            sh '''
                                echo "üîç Verifying EKS access..."
                                aws sts get-caller-identity
                                aws eks list-clusters --region ${AWS_REGION}
                                kubectl get nodes
                                kubectl get namespaces
                                echo "‚úÖ EKS access verified"
                            '''
                        } catch (Exception e) {
                            error "‚ùå EKS access verification failed: ${e.getMessage()}"
                        }
                    }
                }
            }
        }

          
        stage('Setup NGINX Ingress Controller') {
            steps {
                withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: "${AWS_CREDENTIALS_ID}", secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    script {
                        try {
                            sh '''
                                echo "üîß Checking if NGINX Ingress Controller exists..."
                            
                                # Check if ingress-nginx namespace exists
                                if ! kubectl get namespace ingress-nginx >/dev/null 2>&1; then
                                    echo "üì¶ Installing NGINX Ingress Controller..."
                                    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/aws/deploy.yaml --validate=false
                                
                                    echo "‚è≥ Waiting for Ingress Controller to be ready..."
                                    kubectl wait --namespace ingress-nginx \
                                    --for=condition=Ready pod \
                                    --selector=app.kubernetes.io/component=controller \
                                    --timeout=300s
                                else
                                    echo "‚úÖ NGINX Ingress Controller already exists"
                                fi
                            '''
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Warning: Ingress controller setup had issues: ${e.getMessage()}"
                            // Don't fail the pipeline, continue with deployment
                        }
                    }
                }
            }
        }
    
   

        stage('Generate MongoDB Secret') {
            steps {
                script {
                    try {
                        withCredentials([string(credentialsId: "${MONGO_CREDENTIALS_ID}", variable: 'MONGO_URL')]) {
                            sh '''
                                echo "üîê Generating MongoDB secret..."
                                
                                # Create k8s directory if it doesn't exist
                                mkdir -p k8s
                                
                                # Generate base64 encoded MongoDB URI
                                ENCODED_MONGO_URL=$(echo -n "${MONGO_URL}" | base64 -w 0)
                                
                                # Create secret YAML
                                cat > k8s/secret.yml << EOF
apiVersion: v1
kind: Secret
metadata:
  name: mongo-secret
  namespace: default
type: Opaque
data:
  MONGO_URL: ${ENCODED_MONGO_URL}
EOF
                                
                                echo "‚úÖ MongoDB secret generated"
                            '''
                        }
                    } catch (Exception e) {
                        error "‚ùå Failed to generate MongoDB secret: ${e.getMessage()}"
                    }
                }
            }
        }

     stage('Deploy K8s Resources') {
            steps {
                withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: "${AWS_CREDENTIALS_ID}", secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                script {
                    try {
                        sh '''
                            echo " Updating new docker image in yml..."
                            kubectl set image deployment/client client=${DOCKERHUB_USERNAME}/mern-client:${BUILD_NUMBER} --record
                            kubectl set image deployment/server server=${DOCKERHUB_USERNAME}/mern-server:${BUILD_NUMBER} --record

                            echo "üöÄ Deploying Kubernetes resources..."

                            # Delete old resources
                            kubectl delete -f k8s
                            
                            # Apply secret first
                            kubectl apply -f k8s/secret.yml
                            
                            # Apply other resources with timeout
                            kubectl apply -f k8s/client-deployment.yml --timeout=300s
                            kubectl apply -f k8s/server-deployment.yml --timeout=300s
                            
                            # Wait for deployments to be ready
                            echo "‚è≥ Waiting for deployments to be ready..."
                            kubectl wait --for=condition=available --timeout=300s deployment/client-deployment || true
                            kubectl wait --for=condition=available --timeout=300s deployment/server-deployment || true
                            
                            # Apply ingress resources
                            kubectl apply -f k8s/client-ingress.yml
                            kubectl apply -f k8s/server-ingress.yml
                            
                            echo "‚úÖ Kubernetes resources deployed successfully"
                        '''
                    } catch (Exception e) {
                        error "‚ùå Failed to deploy Kubernetes resources: ${e.getMessage()}"
                    }
                }
                }
            }
        }

stage('Verify Deployment') {
            steps {
                                withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: "${AWS_CREDENTIALS_ID}", secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                script {
                    try {
                        sh '''
                            echo "üîç Verifying deployment..."
                            
                            echo "üìä Pods status:"
                            kubectl get pods -o wide
                            
                            echo "üìä Services status:"
                            kubectl get svc
                            
                            echo "üìä Ingress status:"
                            kubectl get ingress
                            
                            echo "üìä Deployment status:"
                            kubectl get deployments
                            
                            # Check if pods are running
                            echo "‚è≥ Waiting for pods to be running..."
                            kubectl wait --for=condition=Ready pod -l app=client --timeout=120s || echo "‚ö†Ô∏è Client pods not ready yet"
                            kubectl wait --for=condition=Ready pod -l app=server --timeout=120s || echo "‚ö†Ô∏è Server pods not ready yet"
                            
                            echo "‚úÖ Deployment verification completed"
                        '''
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Warning: Deployment verification had issues: ${e.getMessage()}"
                        // Don't fail the pipeline, deployment might still be in progress
                    }
                }
                                }
            }
        }
    }

  post {
        always {
            script {
                sh '''
                    echo "üßπ Cleaning up Docker images..."
                    docker system prune -f || true
                    echo "‚úÖ Cleanup completed"
                '''
            }
        }
        success {
            echo '''
            ‚úÖ üéâ DEPLOYMENT SUCCESSFUL! üéâ
            
            Your MERN application has been successfully deployed to EKS!
            Check the ingress endpoints for your application URLs.
            '''
        }
        failure {
            echo '''
            ‚ùå üí• DEPLOYMENT FAILED! üí•
            
            Please check the Jenkins console output for detailed error messages.
            Common issues to check:
            - AWS credentials and permissions
            - Kubernetes cluster connectivity
            - Docker Hub credentials
            - MongoDB connection string
            '''
        }
        unstable {
            echo '‚ö†Ô∏è Deployment completed with warnings. Please review the logs.'
        }
    }
}